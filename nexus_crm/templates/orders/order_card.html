{% extends "base/base.html" %}
{% load static %}
{% block title %} Заявка #{{ order.id }} {% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'crm/css/styles_card.css' %}">

    <div class="container">
        <!-- Заголовок -->
        <header class="order-header">
            <div class="header-info">
                <div class="order-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                </div>
                <div>
                    <h1 class="order-title">Заявка #{{ order.id }}</h1>
                    <p class="order-date">Создана {{ order.created_at|date:"d F Y" }}</p>
                </div>
            </div>
            <a href="{% url 'orders:edit_order' order.id %}" class="settings-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Настройки
            </a>
        </header>

        <!-- Основная информация -->
        <div class="main-grid">
            <!-- Клиент -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon icon-blue" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    <h3>Клиент</h3>
                </div>
                <div class="card-content">
                    {% if order.client %}
                        <h4 class="client-name">{{ order.client.name }}</h4>
                        <div class="contact-info">
                            {% if order.client.phone %}
                                <div class="contact-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                    </svg>
                                    <span>{{ order.client.phone }}</span>
                                </div>
                            {% endif %}
                            {% if order.client.phone_2 %}
                                <div class="contact-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                    </svg>
                                    <span>{{ order.client.phone_2 }}</span>
                                </div>
                            {% endif %}
                            {% if order.client.email %}
                                <div class="contact-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                    <span>{{ order.client.email }}</span>
                                </div>
                            {% endif %}
                            {% if order.client.telegram %}
                                <div class="contact-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                    </svg>
                                    <span>{{ order.client.telegram }}</span>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <p>Клиент не указан</p>
                    {% endif %}
                </div>
            </div>

            <!-- Адрес -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon icon-green" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    <h3>Адрес</h3>
                </div>
                 {% include 'includes/edit_order_address.html' with form=address_form order=order %}

            </div>

            <!-- Услуга -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon icon-orange" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                    </svg>
                    <h3>Услуга</h3>
                </div>
                <div class="card-content">
                    <p class="service-text">{{ order.service|default:"Услуга не указана" }}</p>
                </div>
            </div>
        </div>

        <!-- Детали и задачи -->
        <div class="details-grid">
            <!-- Детали заявки -->
            <div class="card">
                <div class="card-header">
                    <div class="header-left">
                        <svg class="icon icon-purple" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <h3>Детали заявки</h3>
                    </div>
                    <a href="{% url 'orders:order_files' order.id %}" class="files-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                            <polyline points="13,2 13,9 20,9"/>
                        </svg>
                        Файлы
                    </a>
                </div>
                <div class="card-content">
                    <p class="description">{{ order.description|default:"Описание отсутствует" }}</p>
                </div>
            </div>

            <!-- Задачи -->
            <div class="card">
                <div class="card-header">
                    <svg class="icon icon-indigo" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22,4 12,14.01 9,11.01"/>
                    </svg>
                    <h3>Задачи</h3>
                </div>
                <div class="card-content">
                    <div class="tasks-list">
                        {% if order.tasks.all %}
                            {% for task in order.tasks.all %}
                                <div class="task-item">
                                    <div class="task-left">
                                        {% if task.status == 'completed' %}
                                            <svg class="task-icon completed" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                                <polyline points="22,4 12,14.01 9,11.01"/>
                                            </svg>
                                        {% elif task.status == 'in_progress' %}
                                            <svg class="task-icon in-progress" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <polyline points="12,6 12,12 16,14"/>
                                            </svg>
                                        {% else %}
                                            <svg class="task-icon pending" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="12" y1="8" x2="12" y2="12"/>
                                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                                            </svg>
                                        {% endif %}
                                        <span>{{ task.title }}</span>
                                    </div>
                                    <span class="badge badge-{{ task.status }}">{{ task.get_status_display }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p>Задачи отсутствуют</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Расчет стоимости -->
        <div class="card">
            <div class="card-header">
                <svg class="icon icon-emerald" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"/>
                    <path d="M16 8h4a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-4"/>
                    <circle cx="9" cy="9" r="2"/>
                    <path d="M6 21v-7a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v7"/>
                </svg>
                <h3>Расчет стоимости</h3>
            </div>
            <div class="card-content">
                <form method="post" action="{% url 'orders:update_order_costs' order.id %}">
                    {% csrf_token %}
                    <div class="costs-grid">
                        <div class="cost-field">
                            <label for="cost-price">Себестоимость</label>
                            <div class="input-group">
                                <input type="number" id="cost-price" name="cost_price" value="{{ order.cost_price|default:0 }}" oninput="calculateProfit()">
                                <span class="currency">₽</span>
                            </div>
                        </div>
                        <div class="cost-field">
                            <label for="total-price">Стоимость</label>
                            <div class="input-group">
                                <input type="number" id="total-price" name="total_price" value="{{ order.total_price|default:0 }}" oninput="calculateProfit()">
                                <span class="currency">₽</span>
                            </div>
                        </div>
                        <div class="cost-field">
                            <label for="profit">Прибыль</label>
                            <div class="input-group">
                                <input type="number" id="profit" value="{{ order.profit|default:0 }}" readonly>
                                <span class="currency">₽</span>
                            </div>
                        </div>
                    </div>
                    <div class="costs-footer">
                        <p class="auto-calc-text">Прибыль автоматически рассчитывается при изменении цен</p>
                        <button type="submit" class="update-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17,21 17,13 7,13 7,21"/>
                                <polyline points="7,3 7,8 15,8"/>
                            </svg>
                            Обновить расчет
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Подключение скриптов -->
    <script src="{% static 'crm/js/script_card.js' %}"></script>

    <script>
        // Функции для редактирования адреса
        function editAddress() {
            document.getElementById('address-display').classList.add('hidden');
            document.getElementById('address-edit').classList.remove('hidden');
        }

<!--        function cancelEdit() {-->
<!--            document.getElementById('address-edit').classList.add('hidden');-->
<!--            document.getElementById('address-display').classList.remove('hidden');-->
<!--            // Восстановить исходное значение-->
<!--            document.getElementById('address-input').value = '{{ order.address|default:""|escapejs }}';-->
<!--        }-->

<!--        // Автоматический расчет прибыли-->
<!--        function calculateProfit() {-->
<!--            const cost = parseFloat(document.getElementById('cost-price').value) || 0;-->
<!--            const total = parseFloat(document.getElementById('total-price').value) || 0;-->
<!--            const profit = total - cost;-->
<!--            document.getElementById('profit').value = profit;-->
<!--        }-->

        // Инициализация расчета при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            calculateProfit();
        });
    </script>

{% endblock %}